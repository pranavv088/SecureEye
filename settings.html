<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - SecureEye</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap');
        :root {
            --primary: #111111;
            --secondary: #666666;
            --accent: #FF3366;
            --background: #FFFFFF;
            --light-bg: #F8F9FA;
            --border: #EEEEEE;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Space Grotesk', sans-serif; }
        body { background: var(--background); color: var(--primary); }
        .container { max-width: 900px; margin: 40px auto; padding: 0 20px; }
        h1 { font-size: 2.2rem; margin-bottom: 30px; }
        .settings-section { background: var(--light-bg); border-radius: 10px; margin-bottom: 30px; padding: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
        .settings-section h2 { font-size: 1.3rem; margin-bottom: 18px; color: var(--accent); }
        .settings-section label { display: block; margin-bottom: 8px; font-weight: 500; }
        .settings-section input, .settings-section select { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid var(--border); border-radius: 5px; }
        .settings-section input[type="checkbox"] { width: auto; margin-right: 8px; }
        .settings-section .actions { display: flex; gap: 15px; }
        .settings-section button, .settings-section .danger { background: var(--primary); color: #fff; border: none; padding: 10px 22px; border-radius: 4px; font-weight: 500; cursor: pointer; transition: background 0.2s; }
        .settings-section button:hover, .settings-section .danger:hover { background: var(--accent); }
        .settings-section .danger { background: #e74c3c; }
        .profile-pic-preview { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; margin-bottom: 10px; border: 2px solid var(--border); }
        .theme-toggle { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .camera-list { margin-bottom: 15px; }
        .camera-item { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
        .camera-item input { width: auto; flex: 1; }
        .remove-camera { background: #e74c3c; color: #fff; border: none; border-radius: 3px; padding: 3px 8px; cursor: pointer; }
        @media (max-width: 600px) { .settings-section { padding: 15px; } }
    </style>
</head>
<body>
    <div class="container">
        <h1><i class="fas fa-cog"></i> Settings</h1>
        <!-- Profile Section -->
        <div class="settings-section" id="profileSection">
            <h2>Profile</h2>
            <img id="profilePicPreview" class="profile-pic-preview" src="" alt="Profile Picture"/>
            <form id="profileForm">
                <label for="profilePic">Profile Picture</label>
                <input type="file" id="profilePic" accept="image/*">
                <label for="displayName">Name</label>
                <input type="text" id="displayName" required>
                <label for="email">Email</label>
                <input type="email" id="email" required disabled>
                <label for="password">New Password</label>
                <input type="password" id="password" placeholder="Leave blank to keep current">
                <div class="actions">
                    <button type="submit">Save Profile</button>
                </div>
            </form>
        </div>
        <!-- Notification Preferences -->
        <div class="settings-section">
            <h2>Notification Preferences</h2>
            <form id="notifForm">
                <label><input type="checkbox" id="notifEmail"> Email Alerts</label>
                <label><input type="checkbox" id="notifSMS"> SMS Alerts</label>
                <label><input type="checkbox" id="notifPush"> Push Notifications</label>
                <label><input type="checkbox" id="notifBot"> Telegram/WhatsApp Bot</label>
                <div class="actions">
                    <button type="submit">Save Preferences</button>
                </div>
            </form>
        </div>
        <!-- Camera Management -->
        <div class="settings-section">
            <h2>Camera Management</h2>
            <div class="camera-list" id="cameraList"></div>
            <form id="addCameraForm" style="display:flex;gap:10px;align-items:center;">
                <input type="text" id="newCameraName" placeholder="Camera Name" required>
                <input type="text" id="newCameraURL" placeholder="Camera URL" required>
                <button type="submit">Add Camera</button>
            </form>
        </div>
        <!-- Privacy & Data -->
        <div class="settings-section">
            <h2>Privacy & Data</h2>
            <button id="exportData">Export My Data</button>
            <button id="logoutBtn">Sign Out</button>
        </div>
        <!-- Theme -->
        <div class="settings-section">
            <h2>Theme</h2>
            <div class="theme-toggle">
                <label for="themeSwitch">Dark Mode</label>
                <input type="checkbox" id="themeSwitch">
            </div>
        </div>
        <!-- Danger Zone -->
        <div class="settings-section">
            <h2>Danger Zone</h2>
            <button class="danger" id="deleteAccount">Delete Account</button>
        </div>
    </div>
    <script src="firebase-config.js" type="module"></script>
    <script type="module">
    import { getAuth, updateProfile, updatePassword, signOut, deleteUser, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js';
    import { getFirestore, doc, getDoc, setDoc, updateDoc, arrayUnion, arrayRemove } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js';
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js';
    import { app } from './firebase-config.js';
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);
    let currentUser = null;
    // Auth state
    onAuthStateChanged(auth, async (user) => {
        if (!user) {
            window.location.href = 'login.html';
            return;
        }
        currentUser = user;
        document.getElementById('email').value = user.email;
        document.getElementById('displayName').value = user.displayName || '';
        if (user.photoURL) document.getElementById('profilePicPreview').src = user.photoURL;
        else document.getElementById('profilePicPreview').src = 'https://ui-avatars.com/api/?name=' + encodeURIComponent(user.displayName||'User');
        // Load user settings
        const userDoc = await getDoc(doc(db, 'users', user.uid));
        if (userDoc.exists()) {
            const data = userDoc.data();
            // Notification
            document.getElementById('notifEmail').checked = !!data.notifEmail;
            document.getElementById('notifSMS').checked = !!data.notifSMS;
            document.getElementById('notifPush').checked = !!data.notifPush;
            document.getElementById('notifBot').checked = !!data.notifBot;
            // Cameras
            renderCameras(data.cameras || []);
            // Theme
            document.getElementById('themeSwitch').checked = data.theme === 'dark';
            if (data.theme === 'dark') setDarkMode(true);
        } else {
            renderCameras([]);
        }
    });
    // Profile form
    document.getElementById('profileForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!currentUser) return;
        const displayName = document.getElementById('displayName').value;
        const password = document.getElementById('password').value;
        let photoURL = currentUser.photoURL;
        const file = document.getElementById('profilePic').files[0];
        if (file) {
            const picRef = storageRef(storage, 'profilePics/' + currentUser.uid);
            await uploadBytes(picRef, file);
            photoURL = await getDownloadURL(picRef);
        }
        await updateProfile(currentUser, { displayName, photoURL });
        if (password) await updatePassword(currentUser, password);
        await setDoc(doc(db, 'users', currentUser.uid), { displayName, photoURL }, { merge: true });
        alert('Profile updated!');
        location.reload();
    });
    // Profile pic preview
    document.getElementById('profilePic').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(ev) {
                document.getElementById('profilePicPreview').src = ev.target.result;
            };
            reader.readAsDataURL(file);
        }
    });
    // Notification form
    document.getElementById('notifForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!currentUser) return;
        const notifEmail = document.getElementById('notifEmail').checked;
        const notifSMS = document.getElementById('notifSMS').checked;
        const notifPush = document.getElementById('notifPush').checked;
        const notifBot = document.getElementById('notifBot').checked;
        await setDoc(doc(db, 'users', currentUser.uid), { notifEmail, notifSMS, notifPush, notifBot }, { merge: true });
        alert('Notification preferences updated!');
    });
    // Camera management
    async function renderCameras(cameras) {
        const list = document.getElementById('cameraList');
        list.innerHTML = '';
        cameras.forEach((cam, idx) => {
            const div = document.createElement('div');
            div.className = 'camera-item';
            div.innerHTML = `<input type="text" value="${cam.name}" data-idx="${idx}" class="cam-name"/> <input type="text" value="${cam.url}" data-idx="${idx}" class="cam-url"/> <button class="remove-camera" data-idx="${idx}">Remove</button>`;
            list.appendChild(div);
        });
        // Remove camera
        list.querySelectorAll('.remove-camera').forEach(btn => {
            btn.onclick = async function() {
                const idx = +btn.getAttribute('data-idx');
                cameras.splice(idx, 1);
                await setDoc(doc(db, 'users', currentUser.uid), { cameras }, { merge: true });
                renderCameras(cameras);
            };
        });
        // Update camera name/url
        list.querySelectorAll('.cam-name, .cam-url').forEach(input => {
            input.onchange = async function() {
                const idx = +input.getAttribute('data-idx');
                if (input.classList.contains('cam-name')) cameras[idx].name = input.value;
                else cameras[idx].url = input.value;
                await setDoc(doc(db, 'users', currentUser.uid), { cameras }, { merge: true });
            };
        });
    }
    document.getElementById('addCameraForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!currentUser) return;
        const name = document.getElementById('newCameraName').value;
        const url = document.getElementById('newCameraURL').value;
        const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
        let cameras = [];
        if (userDoc.exists()) cameras = userDoc.data().cameras || [];
        cameras.push({ name, url });
        await setDoc(doc(db, 'users', currentUser.uid), { cameras }, { merge: true });
        renderCameras(cameras);
        document.getElementById('addCameraForm').reset();
    });
    // Theme toggle
    function setDarkMode(on) {
        if (on) {
            document.body.style.background = '#181818';
            document.body.style.color = '#fff';
        } else {
            document.body.style.background = 'var(--background)';
            document.body.style.color = 'var(--primary)';
        }
    }
    document.getElementById('themeSwitch').addEventListener('change', async function() {
        const dark = this.checked;
        setDarkMode(dark);
        if (currentUser) await setDoc(doc(db, 'users', currentUser.uid), { theme: dark ? 'dark' : 'light' }, { merge: true });
    });
    // Export data
    document.getElementById('exportData').onclick = async function() {
        if (!currentUser) return;
        const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
        const data = userDoc.exists() ? userDoc.data() : {};
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'secureeye-data.json';
        a.click();
        URL.revokeObjectURL(url);
    };
    // Logout
    document.getElementById('logoutBtn').onclick = async function() {
        await signOut(auth);
        window.location.href = 'login.html';
    };
    // Delete account
    document.getElementById('deleteAccount').onclick = async function() {
        if (!confirm('Are you sure you want to delete your account? This cannot be undone.')) return;
        if (!currentUser) return;
        await deleteUser(currentUser);
        alert('Account deleted.');
        window.location.href = 'signup.html';
    };
    </script>
</body>
</html> 